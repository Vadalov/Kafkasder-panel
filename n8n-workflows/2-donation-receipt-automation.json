{
  "name": "BaÄŸÄ±ÅŸ Makbuzu Otomasyonu",
  "nodes": [
    {
      "parameters": {
        "path": "donation-created",
        "options": {}
      },
      "id": "webhook-donation-1",
      "name": "Webhook - Yeni BaÄŸÄ±ÅŸ",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [250, 300],
      "webhookId": "donation-created-webhook"
    },
    {
      "parameters": {
        "jsCode": "// BaÄŸÄ±ÅŸ verilerini doÄŸrula ve formatla\nconst donation = $input.first().json;\n\n// Zorunlu alanlarÄ± kontrol et\nif (!donation.donor_name || !donation.amount || !donation.receipt_number) {\n  throw new Error('Eksik baÄŸÄ±ÅŸ bilgisi');\n}\n\n// Para birimi formatla\nconst formatCurrency = (amount, currency) => {\n  const symbols = { TRY: 'â‚º', USD: '$', EUR: 'â‚¬' };\n  return `${amount.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} ${symbols[currency] || currency}`;\n};\n\n// Tarih formatla\nconst formattedDate = new Date().toLocaleDateString('tr-TR', {\n  day: '2-digit',\n  month: 'long',\n  year: 'numeric'\n});\n\nreturn [{\n  json: {\n    ...donation,\n    formatted_amount: formatCurrency(donation.amount, donation.currency),\n    formatted_date: formattedDate,\n    is_large_donation: donation.amount >= 5000 && donation.currency === 'TRY',\n    receipt_url: `https://panel.kafkasder.org/receipts/${donation.receipt_number}`\n  }\n}];"
      },
      "id": "code-validate-1",
      "name": "Veri DoÄŸrulama",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "jsCode": "// PDF makbuz iÃ§eriÄŸi oluÅŸtur\nconst data = $input.first().json;\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset=\"utf-8\">\n  <style>\n    body { font-family: Arial, sans-serif; margin: 40px; }\n    .header { text-align: center; border-bottom: 3px solid #4CAF50; padding-bottom: 20px; }\n    .logo { font-size: 24px; color: #4CAF50; font-weight: bold; }\n    .receipt-title { font-size: 20px; margin-top: 10px; }\n    .content { margin-top: 30px; }\n    .row { display: flex; justify-content: space-between; margin: 10px 0; }\n    .label { font-weight: bold; color: #555; }\n    .value { color: #000; }\n    .amount-box { background-color: #f8f8f8; padding: 20px; text-align: center; margin: 30px 0; border: 2px solid #4CAF50; }\n    .amount { font-size: 32px; color: #4CAF50; font-weight: bold; }\n    .footer { margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; font-size: 12px; color: #888; }\n    .qr-code { text-align: center; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <div class=\"logo\">ðŸŒ™ KAFKASDER</div>\n    <div class=\"receipt-title\">BAÄžIÅž MAKBUZU</div>\n    <div>Kafkas KÃ¼ltÃ¼r ve DayanÄ±ÅŸma DerneÄŸi</div>\n  </div>\n  \n  <div class=\"content\">\n    <div class=\"row\">\n      <span class=\"label\">Makbuz No:</span>\n      <span class=\"value\">${data.receipt_number}</span>\n    </div>\n    <div class=\"row\">\n      <span class=\"label\">Tarih:</span>\n      <span class=\"value\">${data.formatted_date}</span>\n    </div>\n    <div class=\"row\">\n      <span class=\"label\">BaÄŸÄ±ÅŸÃ§Ä± AdÄ±:</span>\n      <span class=\"value\">${data.donor_name}</span>\n    </div>\n    <div class=\"row\">\n      <span class=\"label\">Telefon:</span>\n      <span class=\"value\">${data.donor_phone}</span>\n    </div>\n    ${data.donor_email ? `\n    <div class=\"row\">\n      <span class=\"label\">E-posta:</span>\n      <span class=\"value\">${data.donor_email}</span>\n    </div>\n    ` : ''}\n    <div class=\"row\">\n      <span class=\"label\">BaÄŸÄ±ÅŸ TÃ¼rÃ¼:</span>\n      <span class=\"value\">${data.donation_type}</span>\n    </div>\n    <div class=\"row\">\n      <span class=\"label\">BaÄŸÄ±ÅŸ AmacÄ±:</span>\n      <span class=\"value\">${data.donation_purpose}</span>\n    </div>\n    <div class=\"row\">\n      <span class=\"label\">Ã–deme YÃ¶ntemi:</span>\n      <span class=\"value\">${data.payment_method}</span>\n    </div>\n    \n    <div class=\"amount-box\">\n      <div style=\"font-size: 14px; margin-bottom: 10px;\">BAÄžIÅž MÄ°KTARI</div>\n      <div class=\"amount\">${data.formatted_amount}</div>\n    </div>\n    \n    ${data.notes ? `\n    <div class=\"row\">\n      <span class=\"label\">Notlar:</span>\n      <span class=\"value\">${data.notes}</span>\n    </div>\n    ` : ''}\n    \n    <div class=\"qr-code\">\n      <p style=\"font-size: 12px; color: #888;\">Makbuzu doÄŸrulamak iÃ§in QR kodu tarayÄ±n</p>\n      <img src=\"https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${data.receipt_url}\" alt=\"QR Code\">\n    </div>\n  </div>\n  \n  <div class=\"footer\">\n    <p><strong>Allah razÄ± olsun, baÄŸÄ±ÅŸÄ±nÄ±z iÃ§in teÅŸekkÃ¼r ederiz.</strong></p>\n    <p>Bu belge elektronik olarak oluÅŸturulmuÅŸtur ve yasal bir makbuzdur.</p>\n    <p>Kafkasder - Kafkas KÃ¼ltÃ¼r ve DayanÄ±ÅŸma DerneÄŸi</p>\n    <p>Adres: [Dernek Adresi] | Tel: [Telefon] | Web: www.kafkasder.org</p>\n  </div>\n</body>\n</html>\n`;\n\nreturn [{ json: { html, ...data } }];"
      },
      "id": "code-pdf-1",
      "name": "PDF Ä°Ã§erik OluÅŸtur",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "operation": "htmlToPdf",
        "html": "={{$json.html}}",
        "options": {
          "fileName": "bagis_makbuzu_{{$json.receipt_number}}.pdf",
          "margin": {
            "top": "20",
            "right": "20",
            "bottom": "20",
            "left": "20"
          },
          "format": "A4"
        }
      },
      "id": "pdf-convert-1",
      "name": "PDF OluÅŸtur",
      "type": "n8n-nodes-base.html",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "fromEmail": "bagis@kafkasder.org",
        "toEmail": "={{$json.donor_email}}",
        "subject": "BaÄŸÄ±ÅŸÄ±nÄ±z Ä°Ã§in TeÅŸekkÃ¼rler - Makbuz",
        "emailType": "html",
        "message": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; }\n    .header { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 30px; text-align: center; }\n    .content { padding: 30px; }\n    .highlight { background-color: #f0f8f0; padding: 20px; border-left: 4px solid #4CAF50; margin: 20px 0; }\n    .footer { background-color: #f5f5f5; padding: 20px; text-align: center; font-size: 12px; color: #666; }\n    .button { background-color: #4CAF50; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 20px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <h1>ðŸŒ™ KAFKASDER</h1>\n    <h2>BaÄŸÄ±ÅŸÄ±nÄ±z Ä°Ã§in TeÅŸekkÃ¼r Ederiz</h2>\n  </div>\n  \n  <div class=\"content\">\n    <p>SayÄ±n <strong>{{$json.donor_name}}</strong>,</p>\n    \n    <p>Allah razÄ± olsun! <strong>{{$json.formatted_amount}}</strong> tutarÄ±ndaki deÄŸerli baÄŸÄ±ÅŸÄ±nÄ±z iÃ§in iÃ§tenlikle teÅŸekkÃ¼r ederiz.</p>\n    \n    <div class=\"highlight\">\n      <h3>BaÄŸÄ±ÅŸ DetaylarÄ±</h3>\n      <p><strong>Makbuz No:</strong> {{$json.receipt_number}}</p>\n      <p><strong>Tarih:</strong> {{$json.formatted_date}}</p>\n      <p><strong>Tutar:</strong> {{$json.formatted_amount}}</p>\n      <p><strong>BaÄŸÄ±ÅŸ TÃ¼rÃ¼:</strong> {{$json.donation_type}}</p>\n      <p><strong>AmaÃ§:</strong> {{$json.donation_purpose}}</p>\n    </div>\n    \n    <p>BaÄŸÄ±ÅŸÄ±nÄ±z, ihtiyaÃ§ sahibi ailelere ulaÅŸacak ve onlarÄ±n hayatlarÄ±na dokunacak. Bu gÃ¼zel dayanÄ±ÅŸmanÄ±n bir parÃ§asÄ± olduÄŸunuz iÃ§in size minnettarÄ±z.</p>\n    \n    <p>Ekteki PDF dosyasÄ±nda baÄŸÄ±ÅŸ makbuzunuzu bulabilirsiniz. Bu makbuz yasal olarak geÃ§erlidir ve vergi indirimi iÃ§in kullanÄ±labilir.</p>\n    \n    <a href=\"https://panel.kafkasder.org/receipts/{{$json.receipt_number}}\" class=\"button\">Makbuzu Online GÃ¶rÃ¼ntÃ¼le</a>\n    \n    <p>HayÄ±rlÄ± iÅŸlerinizin devamÄ±nÄ± dileriz.</p>\n    <p>SaygÄ±larÄ±mÄ±zla,<br><strong>Kafkasder Ekibi</strong></p>\n  </div>\n  \n  <div class=\"footer\">\n    <p>Kafkas KÃ¼ltÃ¼r ve DayanÄ±ÅŸma DerneÄŸi</p>\n    <p>Web: www.kafkasder.org | E-posta: info@kafkasder.org</p>\n    <p>Bu e-posta otomatik olarak gÃ¶nderilmiÅŸtir.</p>\n  </div>\n</body>\n</html>",
        "options": {
          "attachments": "data:application/pdf;base64,={{$binary.data.data}}"
        }
      },
      "id": "email-send-1",
      "name": "Email Makbuz GÃ¶nder",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1050, 200],
      "credentials": {
        "smtp": {
          "id": "2",
          "name": "Email SMTP"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.is_large_donation}}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-large-1",
      "name": "BÃ¼yÃ¼k BaÄŸÄ±ÅŸ KontrolÃ¼",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1050, 400]
    },
    {
      "parameters": {
        "fromNumber": "={{$env.TWILIO_FROM_NUMBER}}",
        "toNumber": "={{$json.donor_phone}}",
        "message": "SayÄ±n {{$json.donor_name}}, {{$json.formatted_amount}} tutarÄ±ndaki deÄŸerli baÄŸÄ±ÅŸÄ±nÄ±z iÃ§in Allah razÄ± olsun! Makbuz no: {{$json.receipt_number}}. BaÄŸÄ±ÅŸÄ±nÄ±z ihtiyaÃ§ sahiplerine ulaÅŸacak. TeÅŸekkÃ¼rler! - Kafkasder",
        "options": {}
      },
      "id": "sms-send-1",
      "name": "SMS TeÅŸekkÃ¼r GÃ¶nder",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [1250, 500],
      "credentials": {
        "twilioApi": {
          "id": "3",
          "name": "Twilio"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.CONVEX_API_URL}}/donations/update-analytics",
        "method": "POST",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "convexApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"donation_id\": \"{{$json._id}}\",\n  \"amount\": {{$json.amount}},\n  \"currency\": \"{{$json.currency}}\",\n  \"receipt_sent\": true,\n  \"timestamp\": \"{{$now.toISO()}}\"\n}",
        "options": {}
      },
      "id": "http-analytics-1",
      "name": "Analytics GÃ¼ncelle",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "1",
          "name": "Convex API"
        }
      }
    },
    {
      "parameters": {
        "fromNumber": "={{$env.TWILIO_FROM_NUMBER}}",
        "toNumber": "={{$env.ADMIN_PHONE}}",
        "message": "ðŸŽ‰ BÃœYÃœK BAÄžIÅž ALINDI!\n\nBaÄŸÄ±ÅŸÃ§Ä±: {{$json.donor_name}}\nTutar: {{$json.formatted_amount}}\nMakbuz: {{$json.receipt_number}}\n\nDetaylar iÃ§in paneli kontrol edin.",
        "options": {}
      },
      "id": "sms-admin-1",
      "name": "Admin Bildirim SMS",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [1250, 600],
      "credentials": {
        "twilioApi": {
          "id": "3",
          "name": "Twilio"
        }
      }
    }
  ],
  "connections": {
    "Webhook - Yeni BaÄŸÄ±ÅŸ": {
      "main": [
        [
          {
            "node": "Veri DoÄŸrulama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Veri DoÄŸrulama": {
      "main": [
        [
          {
            "node": "PDF Ä°Ã§erik OluÅŸtur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF Ä°Ã§erik OluÅŸtur": {
      "main": [
        [
          {
            "node": "PDF OluÅŸtur",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PDF OluÅŸtur": {
      "main": [
        [
          {
            "node": "Email Makbuz GÃ¶nder",
            "type": "main",
            "index": 0
          },
          {
            "node": "BÃ¼yÃ¼k BaÄŸÄ±ÅŸ KontrolÃ¼",
            "type": "main",
            "index": 0
          },
          {
            "node": "Analytics GÃ¼ncelle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "BÃ¼yÃ¼k BaÄŸÄ±ÅŸ KontrolÃ¼": {
      "main": [
        [
          {
            "node": "SMS TeÅŸekkÃ¼r GÃ¶nder",
            "type": "main",
            "index": 0
          },
          {
            "node": "Admin Bildirim SMS",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "id": "donation-receipt-automation",
  "meta": {
    "instanceId": "vmi2876541.contaboserver.net"
  },
  "tags": [
    {
      "name": "baÄŸÄ±ÅŸ",
      "id": "4"
    },
    {
      "name": "makbuz",
      "id": "5"
    },
    {
      "name": "otomasyon",
      "id": "6"
    }
  ]
}
