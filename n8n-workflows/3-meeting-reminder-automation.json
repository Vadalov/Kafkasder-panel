{
  "name": "ToplantÄ± HatÄ±rlatma Otomasyonu",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 9 * * *"
            }
          ]
        }
      },
      "id": "schedule-daily-1",
      "name": "GÃ¼nlÃ¼k Kontrol (09:00)",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "={{$env.CONVEX_API_URL}}/meetings/upcoming",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "convexApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "from",
              "value": "={{$now.toISO()}}"
            },
            {
              "name": "to",
              "value": "={{$now.plus({hours: 48}).toISO()}}"
            }
          ]
        },
        "options": {}
      },
      "id": "http-meetings-1",
      "name": "YaklaÅŸan ToplantÄ±lar",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [450, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "1",
          "name": "Convex API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ToplantÄ±larÄ± iÅŸle ve katÄ±lÄ±mcÄ±larÄ± geniÅŸlet\nconst meetings = $input.first().json.documents || [];\n\nif (meetings.length === 0) {\n  return [];\n}\n\nconst results = [];\n\nfor (const meeting of meetings) {\n  const meetingDate = new Date(meeting.meeting_date);\n  const now = new Date();\n  const hoursUntil = (meetingDate - now) / (1000 * 60 * 60);\n  \n  // 24-48 saat arasÄ± hatÄ±rlatma gÃ¶nder\n  if (hoursUntil >= 24 && hoursUntil <= 48) {\n    const formattedDate = meetingDate.toLocaleDateString('tr-TR', {\n      day: '2-digit',\n      month: 'long',\n      year: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n    \n    results.push({\n      json: {\n        meeting_id: meeting._id,\n        title: meeting.title,\n        description: meeting.description,\n        meeting_date: meeting.meeting_date,\n        formatted_date: formattedDate,\n        location: meeting.location,\n        organizer_id: meeting.organizer,\n        participant_ids: meeting.participants,\n        meeting_type: meeting.meeting_type,\n        agenda: meeting.agenda,\n        hours_until: Math.round(hoursUntil),\n        reminder_type: '24h'\n      }\n    });\n  }\n}\n\nreturn results;"
      },
      "id": "code-process-1",
      "name": "ToplantÄ±larÄ± Ä°ÅŸle",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-meetings-1",
      "name": "ToplantÄ±larÄ± AyÄ±r",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "={{$env.CONVEX_API_URL}}/users/batch",
        "method": "POST",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "convexApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"user_ids\": {{$json.participant_ids}}\n}",
        "options": {}
      },
      "id": "http-participants-1",
      "name": "KatÄ±lÄ±mcÄ± Bilgileri Al",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "1",
          "name": "Convex API"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "split-participants-1",
      "name": "KatÄ±lÄ±mcÄ±larÄ± AyÄ±r",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "fromEmail": "toplanti@kafkasder.org",
        "toEmail": "={{$json.email}}",
        "subject": "HatÄ±rlatma: {{$json.meeting.title}} - {{$json.meeting.formatted_date}}",
        "emailType": "html",
        "message": "<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 0; padding: 0; }\n    .container { max-width: 600px; margin: 0 auto; }\n    .header { background: linear-gradient(135deg, #2196F3, #1976D2); color: white; padding: 30px; text-align: center; }\n    .content { padding: 30px; background-color: #ffffff; }\n    .meeting-card { background-color: #f5f5f5; border-left: 4px solid #2196F3; padding: 20px; margin: 20px 0; }\n    .info-row { margin: 10px 0; }\n    .label { font-weight: bold; color: #555; }\n    .value { color: #000; }\n    .agenda { background-color: #fff; padding: 15px; border-radius: 5px; margin: 15px 0; }\n    .button { display: inline-block; background-color: #2196F3; color: white; padding: 12px 30px; text-decoration: none; border-radius: 5px; margin: 20px 0; }\n    .footer { background-color: #f5f5f5; padding: 20px; text-align: center; font-size: 12px; color: #666; }\n    .icon { font-size: 20px; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <div class=\"icon\">ğŸ“…</div>\n      <h2>ToplantÄ± HatÄ±rlatmasÄ±</h2>\n    </div>\n    \n    <div class=\"content\">\n      <p>SayÄ±n <strong>{{$json.name}}</strong>,</p>\n      \n      <p>YaklaÅŸan toplantÄ±nÄ±zÄ± hatÄ±rlatmak isteriz:</p>\n      \n      <div class=\"meeting-card\">\n        <h3 style=\"margin-top: 0; color: #2196F3;\">{{$json.meeting.title}}</h3>\n        \n        <div class=\"info-row\">\n          <span class=\"label\">ğŸ“… Tarih ve Saat:</span>\n          <span class=\"value\">{{$json.meeting.formatted_date}}</span>\n        </div>\n        \n        <div class=\"info-row\">\n          <span class=\"label\">â° Kalan SÃ¼re:</span>\n          <span class=\"value\">{{$json.meeting.hours_until}} saat</span>\n        </div>\n        \n        <div class=\"info-row\">\n          <span class=\"label\">ğŸ“ Yer:</span>\n          <span class=\"value\">{{$json.meeting.location || 'Belirtilmedi'}}</span>\n        </div>\n        \n        <div class=\"info-row\">\n          <span class=\"label\">ğŸ·ï¸ ToplantÄ± TÃ¼rÃ¼:</span>\n          <span class=\"value\">{{$json.meeting.meeting_type}}</span>\n        </div>\n      </div>\n      \n      {{#if $json.meeting.description}}\n      <div class=\"info-row\">\n        <p><strong>AÃ§Ä±klama:</strong></p>\n        <p>{{$json.meeting.description}}</p>\n      </div>\n      {{/if}}\n      \n      {{#if $json.meeting.agenda}}\n      <div class=\"agenda\">\n        <h4 style=\"margin-top: 0;\">ğŸ“‹ GÃ¼ndem</h4>\n        <p>{{$json.meeting.agenda}}</p>\n      </div>\n      {{/if}}\n      \n      <a href=\"https://panel.kafkasder.org/meetings/{{$json.meeting.meeting_id}}\" class=\"button\">ToplantÄ± DetaylarÄ±nÄ± GÃ¶rÃ¼ntÃ¼le</a>\n      \n      <p>LÃ¼tfen toplantÄ±ya zamanÄ±nda katÄ±lmayÄ± unutmayÄ±n.</p>\n      \n      <p>Ä°yi Ã§alÄ±ÅŸmalar dileriz.</p>\n    </div>\n    \n    <div class=\"footer\">\n      <p>Kafkas KÃ¼ltÃ¼r ve DayanÄ±ÅŸma DerneÄŸi</p>\n      <p>Bu e-posta otomatik olarak gÃ¶nderilmiÅŸtir.</p>\n    </div>\n  </div>\n</body>\n</html>",
        "options": {}
      },
      "id": "email-reminder-1",
      "name": "Email HatÄ±rlatma GÃ¶nder",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [1450, 250],
      "credentials": {
        "smtp": {
          "id": "2",
          "name": "Email SMTP"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.phone}}",
              "operation": "isNotEmpty"
            }
          ]
        }
      },
      "id": "if-phone-1",
      "name": "Telefon Var mÄ±?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1450, 400]
    },
    {
      "parameters": {
        "fromNumber": "={{$env.TWILIO_FROM_NUMBER}}",
        "toNumber": "={{$json.phone}}",
        "message": "ToplantÄ± HatÄ±rlatma ğŸ“…\n\n{{$json.meeting.title}}\n{{$json.meeting.formatted_date}}\n{{$json.meeting.location}}\n\nKalan: {{$json.meeting.hours_until}} saat\n\nDetaylar: https://panel.kafkasder.org/meetings/{{$json.meeting.meeting_id}}\n\n- Kafkasder",
        "options": {}
      },
      "id": "sms-reminder-1",
      "name": "SMS HatÄ±rlatma GÃ¶nder",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [1650, 500],
      "credentials": {
        "twilioApi": {
          "id": "3",
          "name": "Twilio"
        }
      }
    },
    {
      "parameters": {
        "url": "={{$env.CONVEX_API_URL}}/workflow_notifications/create",
        "method": "POST",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "convexApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"recipient\": \"{{$json._id}}\",\n  \"category\": \"meeting\",\n  \"title\": \"ToplantÄ± HatÄ±rlatmasÄ±: {{$json.meeting.title}}\",\n  \"body\": \"{{$json.meeting.formatted_date}} tarihindeki toplantÄ±nÄ±z yaklaÅŸÄ±yor.\",\n  \"status\": \"gonderildi\",\n  \"created_at\": \"{{$now.toISO()}}\",\n  \"sent_at\": \"{{$now.toISO()}}\",\n  \"reference\": {\n    \"type\": \"meeting\",\n    \"id\": \"{{$json.meeting.meeting_id}}\"\n  }\n}",
        "options": {}
      },
      "id": "http-notification-1",
      "name": "Bildirim Kaydet",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1650, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "1",
          "name": "Convex API"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// KatÄ±lÄ±mcÄ± ve toplantÄ± verilerini birleÅŸtir\nconst participant = $input.first().json;\nconst meeting = $('ToplantÄ±larÄ± AyÄ±r').first().json;\n\nreturn [{\n  json: {\n    ...participant,\n    meeting: meeting\n  }\n}];"
      },
      "id": "code-merge-1",
      "name": "Veri BirleÅŸtir",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 450]
    }
  ],
  "connections": {
    "GÃ¼nlÃ¼k Kontrol (09:00)": {
      "main": [
        [
          {
            "node": "YaklaÅŸan ToplantÄ±lar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "YaklaÅŸan ToplantÄ±lar": {
      "main": [
        [
          {
            "node": "ToplantÄ±larÄ± Ä°ÅŸle",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ToplantÄ±larÄ± Ä°ÅŸle": {
      "main": [
        [
          {
            "node": "ToplantÄ±larÄ± AyÄ±r",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ToplantÄ±larÄ± AyÄ±r": {
      "main": [
        [
          {
            "node": "KatÄ±lÄ±mcÄ± Bilgileri Al",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KatÄ±lÄ±mcÄ± Bilgileri Al": {
      "main": [
        [
          {
            "node": "KatÄ±lÄ±mcÄ±larÄ± AyÄ±r",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "KatÄ±lÄ±mcÄ±larÄ± AyÄ±r": {
      "main": [
        [
          {
            "node": "Veri BirleÅŸtir",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Veri BirleÅŸtir": {
      "main": [
        [
          {
            "node": "Email HatÄ±rlatma GÃ¶nder",
            "type": "main",
            "index": 0
          },
          {
            "node": "Telefon Var mÄ±?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Bildirim Kaydet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telefon Var mÄ±?": {
      "main": [
        [
          {
            "node": "SMS HatÄ±rlatma GÃ¶nder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "1",
  "id": "meeting-reminder-automation",
  "meta": {
    "instanceId": "vmi2876541.contaboserver.net"
  },
  "tags": [
    {
      "name": "toplantÄ±",
      "id": "7"
    },
    {
      "name": "hatÄ±rlatma",
      "id": "8"
    },
    {
      "name": "bildirim",
      "id": "9"
    }
  ]
}
